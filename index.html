<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>uDiscover Quick Search</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0f0f0f;
      color: #e0e0e0;
      min-height: 100vh;
    }

    /* Password Gate */
    #gate {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }

    #gate h1 {
      font-size: 1.4rem;
      margin-bottom: 8px;
      color: #fff;
    }

    #gate p {
      font-size: 0.85rem;
      color: #888;
      margin-bottom: 24px;
    }

    #gate .input-row {
      display: flex;
      gap: 8px;
    }

    #gate input {
      padding: 10px 16px;
      font-size: 1rem;
      border: 1px solid #333;
      border-radius: 6px;
      background: #1a1a1a;
      color: #fff;
      outline: none;
      width: 260px;
    }

    #gate input:focus { border-color: #555; }

    #gate button {
      padding: 10px 20px;
      font-size: 1rem;
      border: none;
      border-radius: 6px;
      background: #fff;
      color: #000;
      cursor: pointer;
      font-weight: 600;
    }

    #gate button:hover { background: #ddd; }

    #gate .error {
      color: #e54;
      font-size: 0.85rem;
      margin-top: 12px;
      min-height: 20px;
    }

    /* App */
    #app {
      display: none;
      max-width: 700px;
      margin: 0 auto;
      padding: 40px 20px;
    }

    #app h1 {
      font-size: 1.5rem;
      color: #fff;
      margin-bottom: 4px;
    }

    #app .subtitle {
      font-size: 0.8rem;
      color: #666;
      margin-bottom: 24px;
    }

    #search-box {
      width: 100%;
      padding: 14px 18px;
      font-size: 1.1rem;
      border: 1px solid #333;
      border-radius: 8px;
      background: #1a1a1a;
      color: #fff;
      outline: none;
      transition: border-color 0.2s;
    }

    #search-box:focus { border-color: #555; }

    #search-box::placeholder { color: #555; }

    #status {
      font-size: 0.8rem;
      color: #666;
      margin-top: 8px;
      min-height: 20px;
    }

    #results {
      margin-top: 16px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .result {
      padding: 12px 16px;
      background: #1a1a1a;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.95rem;
      color: #ccc;
      transition: background 0.15s, color 0.15s;
      user-select: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .result:hover {
      background: #252525;
      color: #fff;
    }

    .result .pid {
      font-size: 0.75rem;
      color: #555;
      font-family: monospace;
      flex-shrink: 0;
      margin-left: 12px;
    }

    .result.copied {
      background: #1a3a1a;
      color: #6f6;
    }

    .result.copied .pid {
      color: #6f6;
    }

    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: #222;
      color: #fff;
      padding: 10px 24px;
      border-radius: 8px;
      font-size: 0.9rem;
      opacity: 0;
      transition: opacity 0.3s, transform 0.3s;
      pointer-events: none;
      border: 1px solid #333;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .no-results {
      text-align: center;
      color: #555;
      padding: 24px;
      font-size: 0.9rem;
    }

    #logout-btn {
      position: fixed;
      top: 16px;
      right: 16px;
      background: none;
      border: 1px solid #333;
      color: #666;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 0.75rem;
      cursor: pointer;
    }

    #logout-btn:hover { color: #aaa; border-color: #555; }
  </style>
</head>
<body>

  <!-- Password Gate -->
  <div id="gate">
    <h1 id="gate-title">Enter Password</h1>
    <p id="gate-subtitle">Access is restricted.</p>
    <div class="input-row">
      <input type="password" id="pw-input" placeholder="Password" autocomplete="off">
      <button id="pw-btn" onclick="handlePassword()">Go</button>
    </div>
    <div class="error" id="pw-error"></div>
  </div>

  <!-- Main App -->
  <div id="app">
    <h1>uDiscover Quick Search</h1>
    <p class="subtitle">Type an artist name. Click a result to copy its Product ID.</p>
    <input type="text" id="search-box" placeholder="Search for an artist..." autofocus>
    <div id="status"></div>
    <div id="results"></div>
    <button id="logout-btn" onclick="logout()">Lock</button>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ─── Password Protection ───────────────────────────────────────────
    // Password hash is stored in localStorage on first setup.
    // First visitor sets the password; subsequent visitors must enter it.
    // To reset: clear localStorage or click Lock and revisit.

    async function sha256(str) {
      const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
      return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    const STORAGE_KEY = 'uds_pw_hash';

    function getStoredHash() {
      return localStorage.getItem(STORAGE_KEY);
    }

    async function handlePassword() {
      const input = document.getElementById('pw-input').value;
      if (!input) return;
      const hash = await sha256(input);
      const stored = getStoredHash();

      if (!stored) {
        // First time: set the password
        localStorage.setItem(STORAGE_KEY, hash);
        sessionStorage.setItem('uds_auth', 'true');
        showApp();
      } else if (hash === stored) {
        sessionStorage.setItem('uds_auth', 'true');
        showApp();
      } else {
        document.getElementById('pw-error').textContent = 'Incorrect password.';
        document.getElementById('pw-input').value = '';
        document.getElementById('pw-input').focus();
      }
    }

    function showApp() {
      document.getElementById('gate').style.display = 'none';
      document.getElementById('app').style.display = 'block';
      document.getElementById('search-box').focus();
    }

    function showGate() {
      document.getElementById('gate').style.display = 'flex';
      document.getElementById('app').style.display = 'none';
      const stored = getStoredHash();
      if (!stored) {
        document.getElementById('gate-title').textContent = 'Create a Password';
        document.getElementById('gate-subtitle').textContent = 'Set a password for this tool. Share it with your team.';
        document.getElementById('pw-btn').textContent = 'Set';
      } else {
        document.getElementById('gate-title').textContent = 'Enter Password';
        document.getElementById('gate-subtitle').textContent = 'Access is restricted.';
        document.getElementById('pw-btn').textContent = 'Go';
      }
    }

    function logout() {
      sessionStorage.removeItem('uds_auth');
      document.getElementById('pw-input').value = '';
      document.getElementById('pw-error').textContent = '';
      document.getElementById('results').innerHTML = '';
      document.getElementById('search-box').value = '';
      showGate();
    }

    // Enter key submits password
    document.getElementById('pw-input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') handlePassword();
    });

    // Check auth on load
    if (sessionStorage.getItem('uds_auth') === 'true' && getStoredHash()) {
      showApp();
    } else {
      showGate();
    }

    // ─── Search ────────────────────────────────────────────────────────
    const SHOP = 'https://shop.udiscovermusic.com';
    const STOREFRONT_TOKEN = 'a951e5fbbd0e64b55496e82642ae06e5';
    const STOREFRONT_URL = 'https://shop.udiscovermusic.com/api/2024-01/graphql.json';
    const ALLORIGINS = 'https://api.allorigins.win/raw?url=';
    let debounceTimer = null;
    let currentQuery = '';

    document.getElementById('search-box').addEventListener('input', (e) => {
      const q = e.target.value.trim();
      currentQuery = q;
      clearTimeout(debounceTimer);

      if (!q) {
        document.getElementById('results').innerHTML = '';
        document.getElementById('status').textContent = '';
        return;
      }

      document.getElementById('status').textContent = 'Searching...';
      debounceTimer = setTimeout(() => search(q), 300);
    });

    async function search(query) {
      if (query !== currentQuery) return;

      try {
        let products;

        // Method 1: Shopify Storefront API (GraphQL, CORS-friendly)
        try {
          products = await searchViaStorefront(query);
        } catch {
          // Method 2: search/suggest.json via allorigins proxy
          products = await searchViaProxy(query);
        }

        if (query !== currentQuery) return;
        renderResults(products);
      } catch (err) {
        if (query !== currentQuery) return;
        document.getElementById('status').textContent = 'Search failed. Try again.';
        document.getElementById('results').innerHTML = '';
      }
    }

    async function searchViaStorefront(query) {
      const gql = {
        query: `{
          search(first: 20, query: "${query.replace(/"/g, '\\"')}", types: PRODUCT) {
            edges {
              node {
                ... on Product {
                  id
                  title
                }
              }
            }
          }
        }`
      };

      const res = await fetch(STOREFRONT_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Shopify-Storefront-Access-Token': STOREFRONT_TOKEN
        },
        body: JSON.stringify(gql)
      });

      if (!res.ok) throw new Error('Storefront API failed');
      const json = await res.json();
      if (json.errors) throw new Error('GraphQL error');

      return json.data.search.edges.map(e => ({
        id: e.node.id.replace('gid://shopify/Product/', ''),
        title: e.node.title
      }));
    }

    async function searchViaProxy(query) {
      const endpoint = `${SHOP}/search/suggest.json?q=${encodeURIComponent(query)}&resources[type]=product&resources[limit]=20`;
      const res = await fetch(ALLORIGINS + encodeURIComponent(endpoint));
      if (!res.ok) throw new Error('Proxy failed');
      const data = await res.json();
      return (data?.resources?.results?.products || []).map(p => ({
        id: String(p.id),
        title: p.title
      }));
    }

    function renderResults(products) {
      const container = document.getElementById('results');
      const status = document.getElementById('status');

      if (products.length === 0) {
        status.textContent = '';
        container.innerHTML = '<div class="no-results">No results found.</div>';
        return;
      }

      status.textContent = `${products.length} result${products.length !== 1 ? 's' : ''}`;
      container.innerHTML = products.map(p => {
        const title = escapeHtml(p.title);
        const id = escapeHtml(String(p.id));
        return `<div class="result" data-id="${id}" onclick="copyProductId(this, '${id}')">
          <span>${title}</span>
          <span class="pid">${id}</span>
        </div>`;
      }).join('');
    }

    async function copyProductId(el, id) {
      try {
        await navigator.clipboard.writeText(id);
        el.classList.add('copied');
        showToast(`Copied: ${id}`);
        setTimeout(() => el.classList.remove('copied'), 1500);
      } catch {
        // Fallback for older browsers
        const ta = document.createElement('textarea');
        ta.value = id;
        ta.style.position = 'fixed';
        ta.style.opacity = '0';
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        el.classList.add('copied');
        showToast(`Copied: ${id}`);
        setTimeout(() => el.classList.remove('copied'), 1500);
      }
    }

    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 1800);
    }

    function escapeHtml(str) {
      const d = document.createElement('div');
      d.textContent = str;
      return d.innerHTML;
    }
  </script>
</body>
</html>
