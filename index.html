<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Buy Button Grabber</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><radialGradient id='g' cx='50%25' cy='50%25' r='50%25'><stop offset='0%25' stop-color='%23fff' stop-opacity='0.9'/><stop offset='30%25' stop-color='%2339ff14'/><stop offset='70%25' stop-color='%2300cc00'/><stop offset='100%25' stop-color='%2300cc00' stop-opacity='0'/></radialGradient><radialGradient id='glow' cx='50%25' cy='50%25' r='50%25'><stop offset='60%25' stop-color='%2339ff14' stop-opacity='0.4'/><stop offset='100%25' stop-color='%2339ff14' stop-opacity='0'/></radialGradient></defs><circle cx='50' cy='50' r='48' fill='url(%23glow)'/><circle cx='50' cy='50' r='30' fill='url(%23g)'/></svg>">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0f0f0f;
      color: #e0e0e0;
      min-height: 100vh;
    }

    /* Password Gate */
    #gate {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }

    #gate h1 { font-size: 1.4rem; margin-bottom: 8px; color: #fff; }
    #gate p { font-size: 0.85rem; color: #888; margin-bottom: 24px; }
    #gate .input-row { display: flex; gap: 8px; }

    #gate input {
      padding: 10px 16px; font-size: 1rem; border: 1px solid #333;
      border-radius: 6px; background: #1a1a1a; color: #fff;
      outline: none; width: 260px;
    }
    #gate input:focus { border-color: #555; }

    #gate button {
      padding: 10px 20px; font-size: 1rem; border: none; border-radius: 6px;
      background: #fff; color: #000; cursor: pointer; font-weight: 600;
    }
    #gate button:hover { background: #ddd; }
    #gate .error { color: #e54; font-size: 0.85rem; margin-top: 12px; min-height: 20px; }

    /* App */
    #app {
      display: none;
      max-width: 700px;
      margin: 0 auto;
      padding: 40px 20px 200px;
    }

    #app h1 { font-size: 1.5rem; color: #fff; margin-bottom: 4px; }
    #app .subtitle { font-size: 0.8rem; color: #666; margin-bottom: 24px; }

    #search-box {
      width: 100%; padding: 14px 18px; font-size: 1.1rem;
      border: 1px solid #333; border-radius: 8px; background: #1a1a1a;
      color: #fff; outline: none; transition: border-color 0.2s;
    }
    #search-box:focus { border-color: #555; }
    #search-box::placeholder { color: #555; }

    #status { font-size: 0.8rem; color: #666; margin-top: 8px; min-height: 20px; }

    /* Manual ID Input */
    #manual-ids-section {
      margin-top: 20px; padding-top: 20px;
      border-top: 1px solid #2a2a2a;
    }
    #manual-ids-section h3 {
      font-size: 0.85rem; color: #888; font-weight: 600; margin-bottom: 8px;
    }
    #manual-ids-section .helper {
      font-size: 0.75rem; color: #555; margin-bottom: 8px;
    }
    #manual-ids-input {
      width: 100%; padding: 10px 14px; font-size: 0.9rem;
      font-family: monospace; border: 1px solid #333; border-radius: 6px;
      background: #1a1a1a; color: #4ec9b0; outline: none;
      resize: vertical; min-height: 60px;
    }
    #manual-ids-input:focus { border-color: #555; }
    #manual-ids-input::placeholder { color: #444; }
    #add-ids-btn {
      margin-top: 8px; padding: 8px 16px; font-size: 0.85rem;
      background: #3a7bd5; color: #fff; border: none; border-radius: 6px;
      cursor: pointer; font-weight: 600;
    }
    #add-ids-btn:hover { background: #2a6bc5; }
    #add-ids-btn:disabled { background: #333; color: #666; cursor: not-allowed; }
    #manual-ids-status {
      font-size: 0.75rem; color: #666; margin-top: 6px; min-height: 18px;
    }
    #manual-ids-status.error { color: #e54; }
    #manual-ids-status.success { color: #4eca7a; }

    #results { margin-top: 16px; display: flex; flex-direction: column; gap: 2px; }

    .result {
      padding: 10px 14px; background: #1a1a1a; border-radius: 6px;
      cursor: pointer; font-size: 0.95rem; color: #ccc;
      transition: background 0.15s, color 0.15s, border-color 0.15s;
      user-select: none; display: flex;
      align-items: center; border: 1px solid transparent;
      gap: 12px;
    }
    .result:hover { background: #252525; color: #fff; }

    .result-thumb {
      width: 50px; height: 50px; border-radius: 4px;
      object-fit: cover; background: #252525; flex-shrink: 0;
      transition: width 0.2s, height 0.2s;
    }
    .result-thumb-placeholder {
      width: 50px; height: 50px; border-radius: 4px;
      background: #252525; flex-shrink: 0;
      transition: width 0.2s, height 0.2s;
    }
    .result.selected .result-thumb,
    .result.selected .result-thumb-placeholder {
      width: 80px; height: 80px;
    }

    .result.selected {
      background: #1a2a3a;
      border-color: #3a7bd5;
      color: #fff;
    }

    .result.selected .pid { color: #3a7bd5; }
    .result.at-limit { opacity: 0.4; cursor: default; }

    .result-content {
      flex: 1; min-width: 0; display: flex; justify-content: space-between;
      align-items: center;
    }

    .result-title {
      flex: 1; min-width: 0; overflow: hidden;
      text-overflow: ellipsis; white-space: nowrap;
    }

    .result-num {
      display: none;
      width: 22px; height: 22px; border-radius: 50%;
      background: #3a7bd5; color: #fff; font-size: 0.75rem;
      font-weight: 700; align-items: center; justify-content: center;
      flex-shrink: 0; margin-right: 10px;
    }
    .result.selected .result-num { display: flex; }

    .result-right {
      display: flex; align-items: center; gap: 8px;
      flex-shrink: 0; margin-left: 12px;
    }

    .result .pid { font-size: 0.75rem; color: #555; font-family: monospace; }

    .result .sold-out {
      font-size: 0.65rem; color: #e54; background: rgba(238, 85, 68, 0.15);
      padding: 2px 6px; border-radius: 3px; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.5px;
    }

    .open-link {
      color: #666; text-decoration: none; font-size: 1rem; line-height: 1;
      padding: 2px 4px; border-radius: 3px; transition: color 0.15s, background 0.15s;
    }
    .open-link:hover { color: #fff; background: #333; }

    /* Tray */
    #tray {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: #161616; border-top: 1px solid #2a2a2a;
      padding: 0; transform: translateY(100%);
      transition: transform 0.25s ease;
      z-index: 100;
    }
    #tray.open { transform: translateY(0); }

    #tray-inner {
      max-width: 700px; margin: 0 auto;
      padding: 16px 20px;
    }

    #tray-header {
      display: flex; justify-content: space-between;
      align-items: center; margin-bottom: 10px;
    }

    #tray-header h2 { font-size: 0.85rem; color: #aaa; font-weight: 600; }

    #tray-clear {
      background: none; border: none; color: #666; font-size: 0.75rem;
      cursor: pointer; padding: 4px 8px;
    }
    #tray-clear:hover { color: #e54; }

    #selected-items {
      display: flex; flex-direction: column; gap: 4px;
      margin-bottom: 12px;
    }

    .selected-item {
      display: flex; align-items: center; gap: 8px;
      font-size: 0.85rem; color: #ccc;
      background: #1a2a3a; border-radius: 4px; padding: 6px 10px;
    }

    .selected-item .sel-num {
      width: 18px; height: 18px; border-radius: 50%;
      background: #3a7bd5; color: #fff; font-size: 0.65rem;
      font-weight: 700; display: flex; align-items: center;
      justify-content: center; flex-shrink: 0;
    }

    .selected-item .sel-title {
      flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }

    .selected-item .sel-remove {
      background: none; border: none; color: #666;
      cursor: pointer; font-size: 1rem; padding: 0 4px; line-height: 1;
    }
    .selected-item .sel-remove:hover { color: #e54; }

    .selected-item.manual { background: #2a1a3a; }
    .manual-badge {
      font-size: 0.6rem; background: #9333ea; color: #fff;
      padding: 2px 5px; border-radius: 3px; margin-left: 6px;
      font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
    }

    #shortcode-area {
      background: #111; border: 1px solid #333; border-radius: 6px;
      padding: 10px 14px; font-family: monospace; font-size: 0.8rem;
      color: #4ec9b0; word-break: break-all; line-height: 1.5;
      margin-bottom: 10px;
    }

    #copy-shortcode {
      width: 100%; padding: 10px; font-size: 0.95rem; font-weight: 600;
      border: none; border-radius: 6px; cursor: pointer;
      background: #3a7bd5; color: #fff; transition: background 0.15s;
    }
    #copy-shortcode:hover { background: #2a6bc5; }
    #copy-shortcode.copied-btn { background: #2a8a4a; }

    .toast {
      position: fixed; bottom: 30px; left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: #222; color: #fff; padding: 10px 24px;
      border-radius: 8px; font-size: 0.9rem; opacity: 0;
      transition: opacity 0.3s, transform 0.3s;
      pointer-events: none; border: 1px solid #333; z-index: 200;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    .no-results { text-align: center; color: #555; padding: 24px; font-size: 0.9rem; }

    #logout-btn {
      position: fixed; top: 16px; right: 16px; background: none;
      border: 1px solid #333; color: #666; padding: 6px 12px;
      border-radius: 4px; font-size: 0.75rem; cursor: pointer;
    }
    #logout-btn:hover { color: #aaa; border-color: #555; }
  </style>
</head>
<body>

  <!-- Password Gate -->
  <div id="gate">
    <h1 id="gate-title">Enter Password</h1>
    <p id="gate-subtitle">Access is restricted.</p>
    <div class="input-row">
      <input type="password" id="pw-input" placeholder="Password" autocomplete="off">
      <button id="pw-btn" onclick="handlePassword()">Go</button>
    </div>
    <div class="error" id="pw-error"></div>
  </div>

  <!-- Main App -->
  <div id="app">
    <h1>uDiscover Quick Search</h1>
    <p class="subtitle">Search for products. Select up to 3, then copy the shortcode.</p>
    <input type="text" id="search-box" placeholder="Search for an artist..." autofocus>
    <div id="status"></div>
    <div id="results"></div>

    <div id="manual-ids-section">
      <h3>Add Product IDs Directly</h3>
      <p class="helper">Paste Shopify product IDs (comma or line separated) for unpublished products</p>
      <textarea id="manual-ids-input" placeholder="8234567890123&#10;8234567890124&#10;8234567890125"></textarea>
      <button id="add-ids-btn" onclick="addManualIds()">Add IDs to Selection</button>
      <div id="manual-ids-status"></div>
    </div>
    <button id="logout-btn" onclick="logout()">Lock</button>
  </div>

  <!-- Selection Tray -->
  <div id="tray">
    <div id="tray-inner">
      <div id="tray-header">
        <h2 id="tray-title">1 product selected</h2>
        <button id="tray-clear" onclick="clearSelection()">Clear all</button>
      </div>
      <div id="selected-items"></div>
      <div id="shortcode-area"></div>
      <button id="copy-shortcode" onclick="copyShortcode()">Copy Shortcode</button>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ─── Password Protection ───────────────────────────────────────────
    async function sha256(str) {
      const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
      return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    const STORAGE_KEY = 'uds_pw_hash';
    function getStoredHash() { return localStorage.getItem(STORAGE_KEY); }

    async function handlePassword() {
      const input = document.getElementById('pw-input').value;
      if (!input) return;
      const hash = await sha256(input);
      const stored = getStoredHash();
      if (!stored) {
        localStorage.setItem(STORAGE_KEY, hash);
        sessionStorage.setItem('uds_auth', 'true');
        showApp();
      } else if (hash === stored) {
        sessionStorage.setItem('uds_auth', 'true');
        showApp();
      } else {
        document.getElementById('pw-error').textContent = 'Incorrect password.';
        document.getElementById('pw-input').value = '';
        document.getElementById('pw-input').focus();
      }
    }

    function showApp() {
      document.getElementById('gate').style.display = 'none';
      document.getElementById('app').style.display = 'block';
      document.getElementById('search-box').focus();
    }

    function showGate() {
      document.getElementById('gate').style.display = 'flex';
      document.getElementById('app').style.display = 'none';
      const stored = getStoredHash();
      if (!stored) {
        document.getElementById('gate-title').textContent = 'Create a Password';
        document.getElementById('gate-subtitle').textContent = 'Set a password for this tool. Share it with your team.';
        document.getElementById('pw-btn').textContent = 'Set';
      } else {
        document.getElementById('gate-title').textContent = 'Enter Password';
        document.getElementById('gate-subtitle').textContent = 'Access is restricted.';
        document.getElementById('pw-btn').textContent = 'Go';
      }
    }

    function logout() {
      sessionStorage.removeItem('uds_auth');
      document.getElementById('pw-input').value = '';
      document.getElementById('pw-error').textContent = '';
      document.getElementById('results').innerHTML = '';
      document.getElementById('search-box').value = '';
      clearSelection();
      showGate();
    }

    document.getElementById('pw-input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') handlePassword();
    });

    if (sessionStorage.getItem('uds_auth') === 'true' && getStoredHash()) {
      showApp();
    } else {
      showGate();
    }

    // ─── Selection State ───────────────────────────────────────────────
    const MAX_SELECTED = 3;
    let selected = []; // Array of { id, title, handle }

    function toggleSelect(product) {
      const idx = selected.findIndex(s => s.id === product.id);
      if (idx !== -1) {
        selected.splice(idx, 1);
      } else {
        if (selected.length >= MAX_SELECTED) return;
        selected.push(product);
      }
      updateTray();
      updateResultHighlights();
    }

    function removeSelected(id) {
      selected = selected.filter(s => s.id !== id);
      updateTray();
      updateResultHighlights();
    }

    function clearSelection() {
      selected = [];
      updateTray();
      updateResultHighlights();
    }

    function buildShortcode() {
      const ids = selected.map(s => s.id).join(',');
      if (selected.length === 1) {
        return `[buy_button_single_product_pre]${ids}[buy_button_single_product_post]`;
      } else if (selected.length === 2) {
        return `[buy_button_two_products_pre]${ids}[buy_button_two_products_post]`;
      } else if (selected.length === 3) {
        return `[buy_button_three_products_pre]${ids}[buy_button_three_products_post]`;
      }
      return '';
    }

    function updateTray() {
      const tray = document.getElementById('tray');
      if (selected.length === 0) {
        tray.classList.remove('open');
        return;
      }
      tray.classList.add('open');

      const count = selected.length;
      document.getElementById('tray-title').textContent =
        `${count} product${count !== 1 ? 's' : ''} selected`;

      document.getElementById('selected-items').innerHTML = selected.map((s, i) => {
        const title = escapeHtml(s.title);
        const id = escapeHtml(s.id);
        const manualBadge = s.isManual ? '<span class="manual-badge">Manual</span>' : '';
        return `<div class="selected-item${s.isManual ? ' manual' : ''}">
          <span class="sel-num">${i + 1}</span>
          <span class="sel-title">${title}${manualBadge}</span>
          <button class="sel-remove" onclick="removeSelected('${id}')" title="Remove">&times;</button>
        </div>`;
      }).join('');

      document.getElementById('shortcode-area').textContent = buildShortcode();
    }

    function updateResultHighlights() {
      const selectedIds = new Set(selected.map(s => s.id));
      const atLimit = selected.length >= MAX_SELECTED;

      document.querySelectorAll('.result').forEach(el => {
        const id = el.dataset.id;
        const isSelected = selectedIds.has(id);
        el.classList.toggle('selected', isSelected);
        el.classList.toggle('at-limit', atLimit && !isSelected);

        const numEl = el.querySelector('.result-num');
        if (numEl) {
          const idx = selected.findIndex(s => s.id === id);
          numEl.textContent = idx !== -1 ? idx + 1 : '';
        }
      });
    }

    async function copyShortcode() {
      const code = buildShortcode();
      if (!code) return;
      try {
        await navigator.clipboard.writeText(code);
      } catch {
        const ta = document.createElement('textarea');
        ta.value = code;
        ta.style.position = 'fixed';
        ta.style.opacity = '0';
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
      }
      const btn = document.getElementById('copy-shortcode');
      btn.textContent = 'Copied!';
      btn.classList.add('copied-btn');
      showToast('Shortcode copied to clipboard');
      setTimeout(() => {
        btn.textContent = 'Copy Shortcode';
        btn.classList.remove('copied-btn');
      }, 2000);
    }

    // ─── Search ────────────────────────────────────────────────────────
    const SHOP = 'https://shop.udiscovermusic.com';
    const STOREFRONT_TOKEN = 'a951e5fbbd0e64b55496e82642ae06e5';
    const STOREFRONT_URL = 'https://shop.udiscovermusic.com/api/2024-01/graphql.json';
    const ALLORIGINS = 'https://api.allorigins.win/raw?url=';
    let debounceTimer = null;
    let currentQuery = '';

    document.getElementById('search-box').addEventListener('input', (e) => {
      const q = e.target.value.trim();
      currentQuery = q;
      clearTimeout(debounceTimer);
      if (!q) {
        document.getElementById('results').innerHTML = '';
        document.getElementById('status').textContent = '';
        return;
      }
      document.getElementById('status').textContent = 'Searching...';
      debounceTimer = setTimeout(() => search(q), 300);
    });

    async function search(query) {
      if (query !== currentQuery) return;
      try {
        let products;
        try {
          products = await searchViaStorefront(query);
        } catch {
          products = await searchViaProxy(query);
        }
        if (query !== currentQuery) return;
        renderResults(products);
      } catch (err) {
        if (query !== currentQuery) return;
        document.getElementById('status').textContent = 'Search failed. Try again.';
        document.getElementById('results').innerHTML = '';
      }
    }

    async function searchViaStorefront(query) {
      const gql = {
        query: `{
          search(first: 20, query: "${query.replace(/"/g, '\\"')}", types: PRODUCT) {
            edges {
              node {
                ... on Product {
                  id
                  title
                  handle
                  availableForSale
                  featuredImage {
                    url(transform: {maxWidth: 100, maxHeight: 100})
                  }
                }
              }
            }
          }
        }`
      };
      const res = await fetch(STOREFRONT_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Shopify-Storefront-Access-Token': STOREFRONT_TOKEN
        },
        body: JSON.stringify(gql)
      });
      if (!res.ok) throw new Error('Storefront API failed');
      const json = await res.json();
      if (json.errors) throw new Error('GraphQL error');
      return json.data.search.edges.map(e => ({
        id: e.node.id.replace('gid://shopify/Product/', ''),
        title: e.node.title,
        handle: e.node.handle,
        availableForSale: e.node.availableForSale,
        imageUrl: e.node.featuredImage?.url || ''
      }));
    }

    async function searchViaProxy(query) {
      const endpoint = `${SHOP}/search/suggest.json?q=${encodeURIComponent(query)}&resources[type]=product&resources[limit]=20`;
      const res = await fetch(ALLORIGINS + encodeURIComponent(endpoint));
      if (!res.ok) throw new Error('Proxy failed');
      const data = await res.json();
      return (data?.resources?.results?.products || []).map(p => ({
        id: String(p.id),
        title: p.title,
        handle: p.handle || p.url?.replace('/products/', '') || '',
        imageUrl: p.featured_image?.url || p.image || ''
      }));
    }

    function renderResults(products) {
      const container = document.getElementById('results');
      const status = document.getElementById('status');
      if (products.length === 0) {
        status.textContent = '';
        container.innerHTML = '<div class="no-results">No results found.</div>';
        return;
      }

      const selectedIds = new Set(selected.map(s => s.id));
      const atLimit = selected.length >= MAX_SELECTED;

      status.textContent = `${products.length} result${products.length !== 1 ? 's' : ''}`;
      container.innerHTML = products.map(p => {
        const title = escapeHtml(p.title);
        const id = escapeHtml(String(p.id));
        const handle = escapeHtml(p.handle || '');
        const url = handle ? `${SHOP}/products/${handle}` : '';
        const isSelected = selectedIds.has(p.id);
        const selIdx = selected.findIndex(s => s.id === p.id);
        const selClass = isSelected ? ' selected' : (atLimit ? ' at-limit' : '');
        const soldOut = p.availableForSale === false;
        const imageUrl = p.imageUrl || '';
        const thumbHtml = imageUrl
          ? `<img class="result-thumb" src="${escapeHtml(imageUrl)}" alt="" loading="lazy">`
          : '<div class="result-thumb-placeholder"></div>';
        return `<div class="result${selClass}" data-id="${id}" data-title="${title}" data-handle="${handle}" onclick="handleResultClick(this)">
          <span class="result-num">${selIdx !== -1 ? selIdx + 1 : ''}</span>
          ${thumbHtml}
          <div class="result-content">
            <span class="result-title">${title}</span>
            <span class="result-right">
              ${soldOut ? '<span class="sold-out">Sold out</span>' : ''}
              <span class="pid">${id}</span>
              ${url ? `<a class="open-link" href="${url}" target="_blank" rel="noopener" onclick="event.stopPropagation()" title="Open product page">&#x2197;</a>` : ''}
            </span>
          </div>
        </div>`;
      }).join('');
    }

    function handleResultClick(el) {
      const product = {
        id: el.dataset.id,
        title: el.dataset.title,
        handle: el.dataset.handle
      };
      toggleSelect(product);
    }

    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 1800);
    }

    function escapeHtml(str) {
      const d = document.createElement('div');
      d.textContent = str;
      return d.innerHTML;
    }

    // ─── Manual ID Input ────────────────────────────────────────────────
    function addManualIds() {
      const input = document.getElementById('manual-ids-input');
      const statusEl = document.getElementById('manual-ids-status');
      const raw = input.value.trim();

      if (!raw) {
        statusEl.textContent = 'Please enter at least one ID';
        statusEl.className = 'error';
        return;
      }

      // Parse IDs (comma or newline separated)
      const ids = raw
        .split(/[\n,]+/)
        .map(id => id.trim())
        .filter(id => id.length > 0);

      if (ids.length === 0) {
        statusEl.textContent = 'No valid IDs found';
        statusEl.className = 'error';
        return;
      }

      // Validate IDs (should be numeric and reasonable length)
      const invalidIds = ids.filter(id => !/^\d{10,15}$/.test(id));
      if (invalidIds.length > 0) {
        statusEl.textContent = `Invalid ID format: ${invalidIds.slice(0, 3).join(', ')}${invalidIds.length > 3 ? '...' : ''}`;
        statusEl.className = 'error';
        return;
      }

      // Check how many slots are available
      const availableSlots = MAX_SELECTED - selected.length;
      if (availableSlots <= 0) {
        statusEl.textContent = 'Selection is full (max 3). Clear some first.';
        statusEl.className = 'error';
        return;
      }

      // Filter out already selected IDs
      const newIds = ids.filter(id => !selected.some(s => s.id === id));
      if (newIds.length === 0) {
        statusEl.textContent = 'All IDs already selected';
        statusEl.className = 'error';
        return;
      }

      // Add IDs (up to available slots)
      const toAdd = newIds.slice(0, availableSlots);
      const skipped = newIds.length - toAdd.length;

      toAdd.forEach(id => {
        selected.push({
          id: id,
          title: `Product ID: ${id}`,
          handle: '',
          isManual: true
        });
      });

      updateTray();
      updateResultHighlights();

      // Clear input and show success
      input.value = '';
      let msg = `Added ${toAdd.length} ID${toAdd.length !== 1 ? 's' : ''}`;
      if (skipped > 0) {
        msg += ` (${skipped} skipped - max 3 total)`;
      }
      statusEl.textContent = msg;
      statusEl.className = 'success';

      // Clear status after a moment
      setTimeout(() => {
        statusEl.textContent = '';
        statusEl.className = '';
      }, 3000);
    }

    // Allow Enter in textarea to add IDs (Shift+Enter for newline)
    document.getElementById('manual-ids-input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        addManualIds();
      }
    });
  </script>
</body>
</html>
